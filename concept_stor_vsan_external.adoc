---
sidebar: sidebar 
permalink: concept_stor_vsan_external.html 
keywords: ontap select, vsan and external array configurations, vnas architecture 
summary: '仮想 NAS (vNAS) の展開では、vSAN、一部の HCI 製品、 NetApp HCIテクノロジー、および外部アレイ タイプのデータストア上のONTAP Selectクラスターがサポートされます。これらの構成の基盤となるインフラストラクチャは、データストアの耐障害性を実現します。' 
---
= ONTAP Select vSANおよび外部アレイ構成
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
仮想 NAS (vNAS) の展開では、仮想 SAN (vSAN)、一部の HCI 製品、および外部アレイ タイプのデータストア上のONTAP Selectクラスターがサポートされます。これらの構成の基盤となるインフラストラクチャは、データストアの耐障害性を実現します。

最小要件は、使用しているハイパーバイザー (サポートされている Linux ホスト上の VMware ESXi または KVM) が基盤となる構成をサポートしていることです。ハイパーバイザーが ESXi の場合、それぞれの VMware HCL にリストされている必要があります。



== vNAS アーキテクチャ

vNAS命名法は、DASを使用しないすべてのセットアップに使用されます。マルチノードONTAP Selectクラスタの場合、これには同じHAペア内の2つのONTAP Selectノードが単一のデータストア（vSANデータストアを含む）を共有するアーキテクチャが含まれます。ノードは、同じ共有外部アレイからの別のデータストアにインストールすることもできます。これにより、アレイ側のストレージ効率が向上し、ONTAP Select HAペア全体のフットプリントを削減できます。ONTAP Select vNASソリューションのアーキテクチャは、ローカルRAIDコントローラを使用するDAS上のONTAP Selectのアーキテクチャと非常によく似ています。つまり、各ONTAP SelectノードはHAパートナーのデータのコピーを引き続き保持します。ONTAPストレージ効率化ポリシーはノードスコープです。したがって、アレイ側のストレージ効率化は、両方のONTAP Selectノードからのデータセットに適用できる可能性があるため、望ましいです。

HA ペアの各 ONTAP Select ノードで別々の外付けアレイを使用することもできます。これは、外付けストレージで ONTAP Select MetroCluster SDS を使用する場合の一般的な選択肢です。

ONTAP Select ノードごとに別々の外付けアレイを使用する場合は、 2 つのアレイが ONTAP Select VM と同様のパフォーマンス特性を発揮することが非常に重要です。



=== vNAS アーキテクチャと、ハードウェア RAID コントローラを搭載したローカル DAS の比較

vNAS アーキテクチャは、 DAS と RAID コントローラを備えたサーバのアーキテクチャと論理的によく似ています。どちらの場合も、 ONTAP Select はデータストアスペースを消費します。そのデータストアスペースは VMDK に分割され、これらの VMDK は従来の ONTAP データアグリゲートを形成します。ONTAP Deploy は、クラスタ作成およびストレージ追加の処理中に、 VMDK が適切なサイズに設定され、正しいプレックスに割り当てられていること（ HA ペアの場合）を確認します。

vNAS と、 RAID コントローラ搭載の DAS には、 2 つの大きな違いがあります。最も明確な違いは、 vNAS には RAID コントローラが必要ないということです。vNAS は、基盤となる外付けアレイが、 RAID コントローラ搭載 DAS が提供するデータの永続性と耐障害性を備えていることを前提としています。2 つ目の違いは、 NVRAM のパフォーマンスに関係します。



== vNAS NVRAM

ONTAP Select NVRAMは VMDK です。つまり、 ONTAP Select は、ブロック アドレス指定可能なデバイス (VMDK) 上でバイト アドレス指定可能な空間 (従来のNVRAM) をエミュレートします。しかし、 NVRAMのパフォーマンスはONTAP Selectノード全体のパフォーマンスにとって極めて重要です。

ハードウェア RAID コントローラを備えた DAS セットアップの場合、 NVRAM VMDK へのすべての書き込みは最初に RAID コントローラ キャッシュでホストされるため、ハードウェア RAID コントローラ キャッシュはNVRAMキャッシュとして機能します。

vNAS アーキテクチャの場合、 ONTAP Deploy は、 Single Instance Data Logging （ SIDL ）というブート引数を使用して、 ONTAP Select ノードを自動的に設定します。このブート引数が指定されている場合、 ONTAP Select は NVRAM をバイパスし、データペイロードをデータアグリゲートに直接書き込みます。NVRAM は、書き込み処理によって変更されたブロックのアドレスを記録するためにのみ使用されます。この機能のメリットは、 NVRAM への 1 つの書き込みと NVRAM のデステージ時のもう 1 つの書き込みで、二重の書き込みを回避できることです。この機能は vNAS でのみ有効です。 RAID コントローラキャッシュへのローカル書き込みでのレイテンシ増がわずかしかないためです。

SIDL 機能は、 ONTAP Select のすべての Storage Efficiency 機能とは互換性がありません。SIDL 機能は、次のコマンドを使用してアグリゲートレベルで無効にできます。

[listing]
----
storage aggregate modify -aggregate aggr-name -single-instance-data-logging off
----

NOTE: SIDL 機能をオフにすると、書き込みパフォーマンスに影響します。アグリゲート内のすべてのボリューム上のすべてのストレージ効率ポリシーを無効にした後で、SIDL 機能を再度有効にすることができます：

[listing]
----
volume efficiency stop -all true -vserver * -volume * (all volumes in the affected aggregate)
----


== ESXiでvNASを使用する場合のONTAP Selectノードの配置

ONTAP Selectには、共有ストレージ上のマルチノードONTAP Selectクラスタのサポートが含まれています。ONTAP Deployでは、これらのノードが同じクラスタの一部でない限り、同じESXiホスト上に複数のONTAP Selectノードを設定できます。


NOTE: この構成は、VNAS環境（共有データストア）に対してのみ有効です。DASストレージを使用する場合、ホストあたりの複数のONTAP Selectインスタンスはサポートされません。これらのインスタンスは同じハードウェアRAIDコントローラを競合するためです。

ONTAP Deployは、マルチノードVNASクラスタの初期導入時に、同じクラスタの複数のONTAP Selectインスタンスが同じホスト上に配置されないようにします。次の図は、2つのホスト上で交差する2つの4ノードクラスタの正しい導入例を示しています。

*マルチノード VNAS クラスタの初期導入*

image:ST_14.jpg["マルチノードVNASクラスタの初期導入"]

導入後、 ONTAP Select ノードはホスト間で移行できます。これにより、不適切な構成やサポート対象外の構成が発生し、同じクラスタにある複数の ONTAP Select ノードが、基盤となる同じホストを共有する可能性があります。ネットアップでは、 VM の非アフィニティルールを手動で作成し、 VMware が、同じ HA ペアのノードだけでなく、同じクラスタのノード間での物理的な分離を自動的に管理するようにすることを推奨します。


NOTE: アンチアフィニティ ルールでは、ESXi クラスタで DRS が有効になっている必要があります。

ONTAP Select VM の非アフィニティルールを作成する方法については、次の例を参照してください。ONTAP Select クラスタに複数の HA ペアが含まれている場合は、クラスタ内のすべてのノードをこのルールに含める必要があります。

image:ST_15.jpg["VM / ホストのルール"]

image:ST_16.jpg["VM / ホストルールを編集します"]

同じONTAP SelectクラスタからONTAP Selectノードが2つ以上、次のいずれかの理由により同じESXiホスト上に見つかる可能性があります：

* VMware vSphere のライセンス制限により DRS がない、または DRS が有効になっていない。
* VMware HA 処理または管理者が開始した VM 移行が優先されるため、 DRS の非アフィニティルールがバイパスされる。



NOTE: ONTAP DeployはONTAP Select VMの場所を積極的に監視しません。ただし、クラスタ更新操作では、このサポートされていない構成がONTAP Deployログに反映されます：

image:ST_17.PNG["ONTAP Deploy ログ"]
