---
sidebar: sidebar 
permalink: concept_nw_vsphere_vswitch_config.html 
keywords: ontap select, standard and distributed vSwitch configurations, vSwitch configuration and load-balancing policies 
summary: 2NIC 構成と 4NIC 構成の ONTAP Select vSwitch 構成とロードバランシングポリシー。 
---
= VMware vSphere vSwitch 構成
:hardbreaks:
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
2NIC 構成と 4NIC 構成の ONTAP Select vSwitch 構成とロードバランシングポリシー。

ONTAP Select では、標準 vSwitch 構成と分散 vSwitch 構成の両方を使用できます。分散 vSwitch は、リンクアグリゲーションの構成要素（ LACP ）をサポートします。リンクアグリゲーションは、複数の物理アダプタ間の帯域幅を集約するために使用される共通のネットワーク構造です。LACP はベンダーに依存しない標準プロトコルです。ネットワークエンドポイントのオープンプロトコルとして、物理ネットワークポートのグループを 1 つの論理チャネルにまとめるために使用します。ONTAP Select は、リンクアグリゲーショングループ（ LAG ）として設定されたポートグループと連携できます。ただし、 LAG 設定を回避するために、個々の物理ポートを単純なアップリンク（トランク）ポートとして使用することを推奨します。このような場合、標準 vSwitch と分散 vSwitch のベストプラクティスは同じです。

このセクションでは、 2NIC 構成と 4NIC 構成で使用する必要がある vSwitch 構成とロードバランシングポリシーについて説明します。

ONTAP Select で使用するポートグループを設定する際には、次のベストプラクティスに従う必要があります。ポートグループレベルでのロードバランシングポリシーは、「 Route Based on Originating Virtual Port ID 」です。VMware では、 ESXi ホストに接続されたスイッチポートで STP を Portfast に設定することを推奨しています。

すべての vSwitch 構成では、少なくとも 2 つの物理ネットワークアダプタを 1 つの NIC チームにまとめる必要があります。ONTAP Select では、 2 ノードクラスタ用に 1 つの 10Gb リンクがサポートされます。ただし、ネットアップでは、 NIC アグリゲーションを使用してハードウェアの冗長性を確保することをベストプラクティスとして推奨します。

vSphere サーバでは、 NIC チームをアグリゲーションの構成要素として使用し、複数の物理ネットワークアダプタを 1 つの論理チャネルにまとめることで、ネットワークの負荷をすべてのメンバーポート間で分散します。重要な点は、物理スイッチのサポートがなくても NIC チームを作成できることです。ロードバランシングポリシーとフェイルオーバーポリシーは NIC チームに直接適用でき、 NIC チームはアップストリームのスイッチ構成を認識しません。この場合、ポリシーはアウトバウンドトラフィックにのみ適用されます。


NOTE: 静的なポートチャネルは、 ONTAP Select ではサポートされません。LACP 対応チャネルは分散 vSwitch でサポートされますが、 LACP LAG を使用すると、 LAG メンバー間で不均衡な負荷分散が実行される場合があります。

シングルノードクラスタの場合、 ONTAP Deploy は、外部ネットワークにポートグループを使用するように ONTAP Select VM を設定し、同じポートグループまたは必要に応じてクラスタとノードの管理トラフィックに別のポートグループを使用するように設定します。シングルノードクラスタの場合は、必要な数の物理ポートを、アクティブアダプタとして外部ポートグループに追加できます。

マルチノードクラスタの場合、 ONTAP Deploy は、内部ネットワーク用に 1 つまたは 2 つのポートグループを使用し、外部ネットワーク用に 1 つまたは 2 つのポートグループを使用するように各 ONTAP Select VM を構成します。クラスタおよびノード管理トラフィックは、外部トラフィックと同じポートグループを使用することも、オプションで別のポートグループを使用することもできます。クラスタおよびノード管理トラフィックは、内部トラフィックと同じポートグループを共有できません。



== 標準または分散 vSwitch および各ノードの 4 つの物理ポート

マルチノードクラスタの各ノードには、 4 つのポートグループを割り当てることができます。各ポートグループには、次の図に示すように、 1 つのアクティブな物理ポートと 3 つのスタンバイ物理ポートがあります。

* 各ノードに 4 つの物理ポートを備えた vSwitch *

image:DDN_08.jpg["ノードごとに 4 つの物理ポートを備えた vSwitch"]

スタンバイリストのポートの順序は重要です。次の表に、 4 つのポートグループにまたがる物理ポートの分散例を示します。

* ネットワークの最小構成と推奨構成 *

[cols="5*"]
|===
| ポートグループ | 外部 1. | 外部 2. | 内部 1 | 内部 2 


| アクティブ | vmnic0 | vmnic1. | vmnic2. | vmnic3. 


| スタンバイ 1. | vmnic1. | vmnic0 | vmnic3. | vmnic2. 


| スタンバイ 2. | vmnic2. | vmnic3. | vmnic0 | vmnic1. 


| スタンバイ 3. | vmnic3. | vmnic2. | vmnic1. | vmnic0 
|===
次の図は、 vCenter GUI からの外部ネットワークポートグループの設定（ ONTAP-External および ONTAP-External2 ）を示しています。アクティブなアダプタは、異なるネットワークカードからのものです。この設定では、 vmnic 4 と vmnic 5 は同じ物理 NIC 上のデュアルポートであり、 vmnic 6 と vmnic 7 は別の NIC 上の同様のデュアルポートです（この例では、 vmnic 0~3 は使用していません）。スタンバイアダプタの順序は階層型のフェイルオーバーを提供し、内部ネットワークのポートは最後になります。スタンバイリストの内部ポートの順序も、 2 つの外部ポートグループ間で同様に入れ替わります。

* パート 1 ： ONTAP Select 外部ポートグループの設定 *

image:DDN_09.jpg["パート 1 ： ONTAP Select 外部ポートグループの設定"]

* パート 2 ： ONTAP Select 外部ポートグループの設定 *

image:DDN_10.jpg["パート 2 ： ONTAP Select の外部ポートグループの設定"]

見やすさを考慮して、次のように割り当てます。

[cols="2*"]
|===
| ONTAP - 外部 | ONTAP-External2 


| アクティブアダプタ： vmnic5 スタンバイアダプタ： vmnic7 、 vmnic4 、 vmnic6 | アクティブアダプタ： vmnic7 スタンバイアダプタ： vmnic5 、 vmnic6 、 vmnic4 
|===
次の図は、内部ネットワークポートグループの設定（ ONTAP-Internal および ONTAP-Internal2 ）を示しています。アクティブなアダプタは、異なるネットワークカードからのものです。この設定では、 vmnic 4 と vmnic 5 は同じ物理 ASIC 上のデュアルポートであり、 vmnic 6 と vmnic 7 は別の ASIC 上の同様のデュアルポートです。スタンバイアダプタの順序は階層型のフェイルオーバーを提供し、外部ネットワークのポートは最後になります。スタンバイリストの外部ポートの順序も、 2 つの内部ポートグループ間で同様に入れ替わります。

* 第 1 部： ONTAP Select 内部ポートグループ設定 *

image:DDN_11.jpg["パート 1 ： ONTAP Select の内部ポートグループの設定"]

* 第 2 部： ONTAP Select 内部ポートグループ *

image:DDN_12.jpg["パート 2 ： ONTAP Select の内部ポートグループ"]

見やすさを考慮して、次のように割り当てます。

[cols="2*"]
|===
| ONTAP - 内部 | ONTAP-Internal2 


| アクティブアダプタ： vmnic4 スタンバイアダプタ： vmnic6 、 vmnic5 、 vmnic7 | アクティブアダプタ： vmnic6 スタンバイアダプタ： vmnic4 、 vmnic7 、 vmnic5 
|===


== 標準または分散 vSwitch および各ノードに 2 つの物理ポート

2 つの高速（ 25 / 40GB ） NIC を使用する場合は、 10Gb アダプタを 4 つ使用する構成と概念的にはほぼ同じです。2 つの物理アダプタだけを使用する場合でも、 4 つのポートグループを使用する必要があります。ポートグループの割り当ては次のとおりです。

[cols="5*"]
|===
| ポートグループ | 外部 1 （ e0a 、 e0b ） | 内部 1 （ e0c 、 e0e ） | 内部 2 （ e0d 、 e0f ） | 外部 2 （ e0g ） 


| アクティブ | vmnic0 | vmnic0 | vmnic1. | vmnic1. 


| スタンバイ | vmnic1. | vmnic1. | vmnic0 | vmnic0 
|===
* ノードごとに 2 つの高速（ 25 / 40GB ）物理ポートを備えた vSwitch *

image:DDN_17.jpg["ノードごとに 2 つの高速（ 25 / 40GB ）物理ポートを備えた vSwitch"]

2 つの物理ポート（ 10Gb 以下）を使用する場合は、各ポートグループにアクティブアダプタとスタンバイアダプタが相互に反対に設定されている必要があります。内部ネットワークは、マルチノード ONTAP Select クラスタにのみ存在します。シングルノードクラスタの場合は、外部ポートグループで両方のアダプタをアクティブとして設定できます。

次の例に示す vSwitch の構成では、 2 つのポートグループがマルチノード ONTAP Select クラスタの内部および外部の通信サービスを処理します。内部ネットワークの VMNIC はこのポートグループの一部であり、スタンバイモードで構成されているため、外部ネットワークはネットワーク停止時に内部ネットワークの VMNIC を使用できます。その逆が、外部ネットワークの場合です。2 つのポートグループ間でアクティブとスタンバイの VMNIC を交互にすることは、ネットワークの停止中に ONTAP Select VM を適切にフェイルオーバーするために重要です。

* 各ノードに 2 つの物理ポート（ 10Gb 以下）を備えた vSwitch *

image:DDN_13.jpg["ノードごとに 2 つの物理ポートを備えた vSwitch"]



== LACP を使用した分散 vSwitch

分散 vSwitch を構成で使用する場合は、ネットワーク構成を簡易化するために LACP を使用できます（ただしベストプラクティスではありません）。サポートされる唯一の LACP 構成では、すべての VMNIC を 1 つの LAG にまとめる必要があります。アップリンクの物理スイッチは、チャネル内のすべてのポートで 7 、 500~9 、 000 の MTU をサポートする必要があります。ONTAP Select の内部ネットワークと外部ネットワークは、ポートグループレベルで分離する必要があります。内部ネットワークはルーティングされない（分離された） VLAN を使用する必要があります。外部ネットワークは VST 、 EST 、または VGT を使用できます。

次に、 LACP を使用した分散 vSwitch の設定例を示します。

* LACP 使用時の LAG プロパティ *

image:DDN_14.jpg["LACP を使用する場合の LAG プロパティ"]

* LACP が有効な分散 vSwitch を使用する外部ポートグループ構成 *

image:DDN_15.jpg["LACP が有効な分散 vSwitch を使用する外部ポートグループ構成"]

* LACP が有効な分散 vSwitch を使用する内部ポートグループ構成 *

image:DDN_16.jpg["LACP が有効な分散 vSwitch を使用する内部ポートグループ構成"]


NOTE: LACP では、アップストリームスイッチポートをポートチャネルとして設定する必要があります。分散 vSwitch でこの構成を有効にする前に、 LACP を有効にしたポートチャネルが適切に構成されていることを確認してください。
