---
sidebar: sidebar 
permalink: concept_stor_hwraid_local.html 
keywords: ontap select, hardware raid, performance boost, protection 
summary: ハードウェア RAID コントローラが使用可能な場合、 ONTAP Select は、書き込みパフォーマンスの向上と物理ドライブの障害に対する保護の両方を実現するために、 RAID サービスをハードウェアコントローラに移動できます。このため、 ONTAP Select クラスタ内のすべてのノードに対する RAID 保護は、 ONTAP ソフトウェア RAID ではなく、ローカルに接続された RAID コントローラによって実装されます。 
---
= ローカル接続ストレージ向けのハードウェア RAID サービス
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./media/


[role="lead"]
ハードウェア RAID コントローラが使用可能な場合、 ONTAP Select は、書き込みパフォーマンスの向上と物理ドライブの障害に対する保護の両方を実現するために、 RAID サービスをハードウェアコントローラに移動できます。このため、 ONTAP Select クラスタ内のすべてのノードに対する RAID 保護は、 ONTAP ソフトウェア RAID ではなく、ローカルに接続された RAID コントローラによって実装されます。


NOTE: 物理 RAID コントローラが基盤のドライブの RAID ストライピングを提供しているため、 ONTAP Select データアグリゲートは RAID 0 を使用するように設定されています。その他の RAID レベルはサポートされません。



== ローカル接続ストレージ用の RAID コントローラ構成

ONTAP Select にバッキングストレージを提供するローカル接続ディスクは、すべて RAID コントローラの背後に設置する必要があります。ほとんどのコモディティサーバには、価格の異なる複数の RAID コントローラが用意されており、その機能レベルもそれぞれに異なります。コントローラに設定された一定の最小要件を満たしていれば、これらのオプションをできるだけ多くサポートすることが意図されています。

ONTAP Select ディスクを管理する RAID コントローラは、次の要件を満たしている必要があります。

* ハードウェア RAID コントローラは、 Battery Backup Unit （ BBU ；バッテリバックアップユニット）または Flash-Backed Write Cache （ FBWC ；フラッシュバック式ライトキャッシュ）を搭載し、かつ 12Gbps のスループットをサポートする必要があります。
* RAID コントローラは、少なくとも 1 つまたは 2 つのディスク障害に耐えるモード（ RAID 5 および RAID 6 ）をサポートする必要があります。
* ドライブキャッシュを無効に設定する必要があります。
* ライトバックモードの書き込みポリシーは、 BBU またはフラッシュの障害発生時にライトスルーにフォールバックするように設定する必要があります。
* 読み取りの I/O ポリシーは、キャッシュに設定する必要があります。


ONTAP Select にバッキングストレージを提供するローカル接続ディスクは、 RAID5 または RAID6 を実行する RAID グループにすべて配置する必要があります。SAS ドライブと SSD については、最大 24 本のドライブで構成される RAID グループを使用することで、 ONTAP は受信する読み取り要求をより多くのディスクに分散するというメリットを享受できます。これにより、パフォーマンスが大幅に向上します。SAS / SSD 構成では、シングル LUN 構成とマルチ LUN 構成の両方に対してパフォーマンステストが実施されました。両者に大きな違いは見られなかったため、シンプルさという観点から、構成のニーズを満たす必要最小限の数の LUN を作成することを推奨します。

NL-SAS ドライブと SATA ドライブでは、別のベストプラクティスが必要です。最小ディスク数は同じく 8 ですが、パフォーマンス上の理由から、 RAID グループは 12 ドライブ以下にする必要があります。また、 RAID グループごとに 1 つのスペアを使用することも推奨します。ただし、すべての RAID グループに対してグローバルスペアを使用できます。たとえば、 8~12 本のドライブで構成する 3 つの RAID グループごとに 2 つのスペアを使用できます。


NOTE: 古い ESX リリースのエクステントとデータストアの最大サイズは 64TB です。これは、これらの大容量ドライブが提供する合計物理容量をサポートするために必要な LUN の数に影響を与える可能性があります。



== RAID モード

多くの RAID コントローラは、最大 3 つの動作モードをサポートしており、書き込み要求のデータパスはそれぞれのモードで大きく異なります。これらの 3 つのモードは次のとおりです。

* ライトスルー：受信した I/O 要求はすべて RAID コントローラキャッシュに書き込まれ、ただちにディスクにフラッシュされてから、確認応答がホストに返されます。
* ライトアラウンド：受信した I/O 要求はすべて RAID コントローラキャッシュには書き込まれずにディスクに直接書き込まれます。
* ライトバック：受信した I/O 要求はすべてコントローラキャッシュに直接書き込まれ、確認応答がただちにホストに返されます。データブロックは、コントローラを使用して非同期にディスクにフラッシュされます。


ライトバックモードでは、データパスが最短になり、ブロックがキャッシュに入るとすぐに I/O 確認が行われます。このモードでは、読み取り / 書き込みの混在ワークロードに対して、最小のレイテンシと最大のスループットが実現されます。ただし、 BBU または不揮発性フラッシュテクノロジがない場合、このモードで動作しているときにシステムに電源障害が発生すると、データが失われる危険性があります。

ONTAP Select にはバッテリバックアップユニットまたはフラッシュユニットが必須であるため、この種の障害が発生した場合でもキャッシュされたブロックを確実にディスクへフラッシュできます。この理由から、 RAID コントローラはライトバックモードで構成する必要があります。



== ONTAP Select と OS でローカルディスクを共有します

最も一般的なサーバ構成では、すべてのローカル接続スピンドルが 1 台の RAID コントローラの背後に配置されます。ハイパーバイザー用と ONTAP Select VM 用の少なくとも 2 つの LUN をプロビジョニングする必要があります。

たとえば、 6 本のドライブを内蔵した HP DL380 g8 と 1 台の Smart Array P420i RAID コントローラがあるとします。すべての内蔵ドライブはこの RAID コントローラによって管理されており、システムには他のストレージが存在しません。

次の図に、この構成を示します。この例では、システムに他のストレージが存在しないため、ハイパーバイザーは ONTAP Select ノードとストレージを共有する必要があります。

* RAID で管理されるスピンドルのみを使用するサーバ LUN 構成 *

image:ST_08.jpg["RAID で管理されるスピンドルのみを使用するサーバ LUN 構成"]

ONTAP Select と同じ RAID グループから OS の LUN をプロビジョニングすると、ハイパーバイザー OS （およびこのストレージからプロビジョニングされるすべてのクライアント VM ）に RAID 保護が適用されます。この構成では、単一ドライブ障害が発生してもシステム全体が停止することを防止できます。



== ONTAP Select と OS でローカルディスクがスプリットされている

サーバベンダーが提供するもう 1 つの構成は、複数の RAID コントローラまたはディスクコントローラを使用するシステム構成です。この構成では、ディスクセットは、 RAID サービスを提供する、または提供しない 1 つのディスクコントローラで管理されます。2 番目のディスクセットは、 RAID 5 / 6 サービスを提供できるハードウェア RAID コントローラによって管理されます。

この構成では、 RAID 5 / 6 サービスを提供する RAID コントローラの背後にある一連のスピンドルを ONTAP Select VM が排他的に使用します。管理対象の合計ストレージ容量によっては、ディスクスピンドルを複数の RAID グループおよび LUN に分散するように設定する必要があります。これらの LUN を使用してデータストアが作成され、すべてのデータストアが RAID コントローラで保護されます。

最初のディスクセットは、次の図に示すように、ハイパーバイザー OS および ONTAP ストレージを使用しないクライアント VM 用に予約されます。

* RAID / 非 RAID 混在システム * 上のサーバー LUN 構成

image:ST_09.jpg["RAID / 非 RAID が混在するシステムでのサーバ LUN 構成"]



== 複数の LUN

単一 RAID グループ / 単一 LUN 構成の変更が必要になるケースは 2 つあります。NL-SAS ドライブまたは SATA ドライブを使用している場合は、 RAID グループのサイズが 12 ドライブを超えないようにする必要があります。また、単一の LUN は、個々のファイルシステムエクステントの最大サイズまたはストレージプール全体の最大サイズのいずれかが、基盤となるハイパーバイザーストレージの制限よりも大きくなる可能性があります。その場合、基盤となる物理ストレージを複数の LUN に分割して、ファイルシステムを正常に作成できるようにする必要があります。



== VMware vSphere 仮想マシンのファイルシステムの制限

ESX の一部のバージョンでは、データストアの最大サイズは 64TB です。

サーバに 64TB を超えるストレージが接続されている場合は、 64TB 未満の LUN を複数プロビジョニングすることが必要になる場合があります。SATA / NL-SAS ドライブで RAID のリビルド時間を短縮するために複数の RAID グループを作成した場合も、複数の LUN がプロビジョニングされます。

複数の LUN が必要な場合は、各 LUN にほぼ同等で一貫したパフォーマンスを確保することが重要な検討事項となります。これは、すべての LUN を単一の ONTAP アグリゲートで使用する場合に特に重要です。あるいは、一部の LUN のパフォーマンスプロファイルが明らかに他と異なる場合は、それらの LUN を別の ONTAP アグリゲートに分離することを強く推奨します。

複数のファイルシステムエクステントを使用して、データストアの最大サイズいっぱいまで単一のデータストアを作成できます。ONTAP Select ライセンスが必要な容量を制限するには、クラスタをインストールする際に必ず容量の上限を指定してください。この機能は、 ONTAP Select にデータストアの一部のスペースのみの使用を許可します（したがってこのスペース分のライセンスが必要となります）。

あるいは、 1 つの LUN に作成した単一のデータストアから始めることもできます。ONTAP Select の容量ライセンスをさらに必要とするスペースが追加されると、そのスペースをデータストアの最大サイズまでエクステントとして同じデータストアに追加できます。最大サイズに達したら、新しいデータストアを作成して ONTAP Select に追加できます。どちらのタイプの容量拡張処理もサポートされており、 ONTAP Deploy のストレージ追加機能を使用して実行できます。各 ONTAP Select ノードは、最大 400TB のストレージをサポートするように設定できます。複数のデータストアから容量をプロビジョニングするには、 2 つの手順を実行する必要があります。

最初のクラスタ作成手順では、初期データストアの一部またはすべてのスペースを消費する ONTAP Select クラスタを作成します。次に、目的の合計容量に達するまで、追加のデータストアを使用して 1 つ以上の容量追加処理を実行します。この機能の詳細については、を参照してください link:concept_stor_capacity_inc.html["ストレージ容量を増やしています"]。


NOTE: VMFS オーバーヘッドはゼロ以外です（を参照） link:https://kb.vmware.com/s/article/1001618["VMware KB 1001618"]）を削除し、データストアによって空きとして報告されたスペース全体を使用しようとすると、クラスタ作成処理中に誤ったエラーが発生していました。

各データストアで 2% のバッファが未使用のままになります。このスペースは ONTAP Select では使用されないため、容量ライセンスは必要ありません。ONTAP Deploy は、容量上限が指定されていないかぎり、バッファの正確なギガバイト数を自動的に計算します。容量上限を指定すると、そのサイズが最初に適用されます。容量上限のサイズがバッファサイズの範囲内である場合、クラスタ作成は失敗し、容量上限として使用できる正しい最大サイズのパラメータを示すエラーメッセージが表示されます。

[listing]
----
“InvalidPoolCapacitySize: Invalid capacity specified for storage pool “ontap-select-storage-pool”, Specified value: 34334204 GB. Available (after leaving 2% overhead space): 30948”
----
VMFS 6 は、新規インストールの場合も、既存の ONTAP Deploy または ONTAP Select VM の Storage vMotion 操作のターゲットの場合もサポートされます。

VMware では、 VMFS 5 から VMFS 6 へのインプレースアップグレードはサポートしていません。このため、 VM が VMFS 5 データストアから VMFS 6 データストアに移行できる唯一のメカニズムは Storage vMotion です。ただし、 ONTAP Select と ONTAP Deploy を使用した Storage vMotion のサポートが拡張され、 VMFS 5 から VMFS 6 への移行という特定の目的に加えて、他のシナリオにも対応できるようになりました。



== ONTAP Select 仮想ディスク

ONTAP Select の基本的な役割は、 1 つ以上のストレージプールから一連の仮想ディスクをプロビジョニングして ONTAP に提供することです。ONTAP は提供された仮想ディスクを物理ディスクとして扱い、ストレージスタックの残りの部分はハイパーバイザーによって抽象化されます。次の図はこの関係を詳しく表したもので、物理 RAID コントローラ、ハイパーバイザー、 ONTAP Select VM の間の関係にフォーカスしています。

* RAID グループと LUN の構成は、サーバの RAID コントローラソフトウェア内で行われます。VSAN または外付けアレイを使用する場合は、この構成は必要ありません。
* ストレージプールの構成はハイパーバイザー内で行われます。
* 仮想ディスクは個々の VM によって作成および所有されます。この例では、 ONTAP Select によって作成されます。


* 仮想ディスクと物理ディスクのマッピング *

image:ST_12.jpg["仮想ディスクと物理ディスクのマッピング"]



== 仮想ディスクのプロビジョニング

より効率的なユーザエクスペリエンスを実現するために、 ONTAP Select 管理ツールである ONTAP Deploy によって、関連するストレージプールから仮想ディスクが自動的にプロビジョニングされて ONTAP Select VM に接続されます。この処理は、初期セットアップ時およびストレージ追加処理の実行中に自動的に行われます。ONTAP Select ノードが HA ペアの一部である場合、仮想ディスクは自動的にローカルストレージプールとミラーストレージプールに割り当てられます。

ONTAP Select は、基盤となる接続ストレージを同サイズの仮想ディスクに分割し、それぞれが 16TB を超えないようにします。ONTAP Select ノードが HA ペアの一部である場合は、各クラスタノードに少なくとも 2 本の仮想ディスクが作成され、ミラーされたアグリゲート内で使用されるローカルプレックスとミラープレックスに割り当てられます。

たとえば、 ONTAP Select では、 31TB のデータストアまたは LUN を割り当てることができます（ VM の導入後のスペースと、システムディスクおよびルートディスクのプロビジョニング後のスペース）。その後、 4~7.75TB の仮想ディスクが作成され、適切な ONTAP ローカルプレックスとミラープレックスに割り当てられます。


NOTE: ONTAP Select VM に容量を追加すると、サイズの異なる VMDK が作成されることがあります。詳細については、を参照してください link:concept_stor_capacity_inc.html["ストレージ容量を増やしています"]。FAS システムとは異なり、同じアグリゲートにサイズの異なる VMDK を配置できます。ONTAP Select では、これらの VMDK にまたがる RAID 0 のストライプを使用するため、各 VMDK のすべてのスペースをそのサイズに関係なく完全に使用できます。



== 仮想 NVRAM

NetApp FAS システムには、従来より、不揮発性フラッシュメモリを搭載した高性能カードである物理 NVRAM PCI カードが取り付けられていました。このカードを使用すると、クライアントへのライトバックをすぐに確認できる機能が ONTAP に付与されるため、書き込みパフォーマンスが大幅に向上します。また、変更されたデータブロックを低速のストレージメディアに移動する、デステージと呼ばれるプロセスをスケジュール設定することもできます。

コモディティシステムには通常、このタイプの機器が取り付けられていません。このため、この NVRAM カードの機能が仮想化されて、 ONTAP Select システムブートディスク上のパーティションに配置されてきました。そのため、インスタンスのシステム仮想ディスクの配置は非常に重要です。これは、この製品がローカル接続ストレージ構成で耐障害性に優れたキャッシュを備えた物理 RAID コントローラを必要とする理由でもあります。

NVRAM は独自の VMDK に配置されます。NVRAM を独自の VMDK に分割すると、 ONTAP Select VM は vNVMe ドライバを使用して NVRAM VMDK と通信できるようになります。また、 ONTAP Select VM では、 ESX 6.5 以降と互換性のあるハードウェアバージョン 13 を使用する必要があります。



== データパスの説明： NVRAM と RAID コントローラ

システムが受信した書き込み要求のデータパスをたどると、仮想化された NVRAM システムパーティションと RAID コントローラの間の連携がよくわかります。

ONTAP Select VM への書き込み要求は、 VM の NVRAM パーティションを対象としています。仮想化レイヤでは、このパーティションは ONTAP Select システムディスク、つまり ONTAP Select VM に接続された VMDK 内にあります。物理レイヤでは、基盤のスピンドルをターゲットとするすべてのブロック変更と同様に、これらの要求はローカルの RAID コントローラにキャッシュされます。ここで、書き込みの確認応答がホストに返されます。

この時点で物理的には、該当するブロックは RAID コントローラキャッシュにあり、ディスクにフラッシュされるのを待機しています。論理的には、ブロックは適切なユーザデータディスクへのデステージを待機する NVRAM にあります。

変更されたブロックは RAID コントローラのローカルキャッシュに自動的に格納されるため、 NVRAM パーティションへの書き込みは自動的にキャッシュされ、物理ストレージメディアに定期的にフラッシュされます。この処理を、 NVRAM の内容が ONTAP データディスクに定期的にフラッシュされる処理と混同しないでください。この 2 つの処理に関連性はなく、実行されるタイミングも頻度も異なります。

次の図に、書き込みで使用される I/O パスを示します。ここでは、物理レイヤ（ RAID コントローラキャッシュとディスクで表される）と仮想レイヤ（ VM の NVRAM とデータ仮想ディスクで表される）の違いが強調されています。


NOTE: NVRAM VMDK 上で変更されたブロックはローカルの RAID コントローラキャッシュにキャッシュされますが、キャッシュ自体は VM の構成要素もその仮想ディスクも認識しません。システム上の変更されたブロックをすべて格納し、 NVRAM はその一部に過ぎません。これには、ハイパーバイザーにバインドされている書き込み要求も含まれます（同じバッキングスピンドルからプロビジョニングされている場合）。

* ONTAP Select VM への書き込み *

image:ST_13.jpg["ONTAP Select VM への書き込み"]


NOTE: NVRAM パーティションは、専用の VMDK に分割されます。その VMDK は、 ESX バージョン 6.5 以降で使用可能な vNVME ドライバを使用して接続されます。この変更は、ソフトウェア RAID を使用した ONTAP Select のインストールで最も重要です。 RAID コントローラキャッシュによるメリットはありません。
